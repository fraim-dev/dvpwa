name: Comprehensive Security Scan

on:
  push:
    branches: [ master, main ]
  pull_request:
    branches: [ master, main ]
  schedule:
    # Run daily at 4 AM UTC
    - cron: '0 4 * * *'

jobs:
  security-scan:
    name: Comprehensive Security Analysis
    runs-on: ubuntu-latest
    
    permissions:
      contents: read
      actions: read
      security-events: write
      pull-requests: write
      issues: write
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.9'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      # Bandit - Python security linter
      - name: Run Bandit Security Linter
        uses: gaurav-nelson/bandit-action@v1.0.1
        with:
          path: "sqli/"
          level: "medium"
          confidence: "medium"
          format: "json"
          output: "bandit-report.json"

      # Safety - Check for known security vulnerabilities in dependencies
      - name: Run Safety Check
        run: |
          pip install safety
          safety check --json --output safety-report.json || true

      # Semgrep - Static analysis for security issues
      - name: Run Semgrep
        uses: returntocorp/semgrep-action@v1
        with:
          config: >-
            p/security-audit
            p/python
            p/owasp-top-ten
            p/security-audit
          generateSarif: "1"
          generateGitlabSAST: "1"
          generateGitlabSecrets: "1"

      # Generate comprehensive security report
      - name: Generate Security Report
        if: always()
        run: |
          echo "# 🔒 Security Scan Report" > security-report.md
          echo "" >> security-report.md
          echo "**Scan Date:** $(date)" >> security-report.md
          echo "**Repository:** ${{ github.repository }}" >> security-report.md
          echo "**Branch:** ${{ github.ref_name }}" >> security-report.md
          echo "**Commit:** ${{ github.sha }}" >> security-report.md
          echo "" >> security-report.md
          
          # Bandit results
          if [ -f "bandit-report.json" ]; then
            echo "## 🛡️ Bandit Security Linter Results" >> security-report.md
            echo "" >> security-report.md
            bandit_count=$(jq '.results | length' bandit-report.json)
            if [ "$bandit_count" -gt 0 ]; then
              echo "⚠️ Found $bandit_count security issues:" >> security-report.md
              echo "" >> security-report.md
              jq -r '.results[] | "- **\(.test_name)**: \(.issue_text) in \(.filename):\(.line_number)"' bandit-report.json >> security-report.md
            else
              echo "✅ No security issues found by Bandit" >> security-report.md
            fi
            echo "" >> security-report.md
          fi
          
          # Safety results
          if [ -f "safety-report.json" ]; then
            echo "## 📦 Safety Dependency Check Results" >> security-report.md
            echo "" >> security-report.md
            safety_count=$(jq '. | length' safety-report.json)
            if [ "$safety_count" -gt 0 ]; then
              echo "⚠️ Found $safety_count vulnerable dependencies:" >> security-report.md
              echo "" >> security-report.md
              jq -r '.[] | "- **\(.package)**: \(.advisory)"' safety-report.json >> security-report.md
            else
              echo "✅ No vulnerable dependencies found" >> security-report.md
            fi
            echo "" >> security-report.md
          fi
          
          echo "## 📊 Summary" >> security-report.md
          echo "" >> security-report.md
          echo "This comprehensive security scan includes:" >> security-report.md
          echo "- **Bandit**: Python security linter" >> security-report.md
          echo "- **Safety**: Dependency vulnerability scanner" >> security-report.md
          echo "- **Semgrep**: Static analysis for security issues" >> security-report.md
          echo "" >> security-report.md
          echo "For detailed results, check the Security tab in GitHub." >> security-report.md

      # Comment PR with security report
      - name: Comment PR with Security Report
        if: github.event_name == 'pull_request'
        uses: actions/github-script@v6
        with:
          script: |
            const fs = require('fs');
            try {
              const report = fs.readFileSync('security-report.md', 'utf8');
              github.rest.issues.createComment({
                issue_number: context.issue.number,
                owner: context.repo.owner,
                repo: context.repo.repo,
                body: report
              });
            } catch (error) {
              console.log('Could not read security report:', error);
            }
